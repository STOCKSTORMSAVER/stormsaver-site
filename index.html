<script>
  const WEB_APP_URL = "YOUR_WEB_APP_URL_HERE"; // keep your latest URL

  // Small connection badge
  const conn = document.createElement("div");
  conn.style.cssText = "position:fixed;right:12px;bottom:12px;background:#eef6ff;border:1px solid #93c5fd;padding:8px 10px;border-radius:10px;font:12px/1.1 system-ui;color:#1e3a8a;z-index:9999";
  conn.textContent = "Connecting…";
  document.body.appendChild(conn);
  function setConn(ok,msg){
    conn.style.background = ok ? "#ecfdf5" : "#fef2f2";
    conn.style.borderColor = ok ? "#86efac" : "#fecaca";
    conn.style.color = ok ? "#065f46" : "#7f1d1d";
    conn.textContent = (ok ? "Connected: " : "Connection issue: ") + msg;
  }

  // Robust API call: JSONP with timeout, then fetch JSON with CORS
  function api(params, timeoutMs=7000){
    const base = WEB_APP_URL + (WEB_APP_URL.includes("?") ? "&" : "?") + params;
    return new Promise((resolve) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      let done = false;
      const cleanup = () => { if (s.parentNode) s.parentNode.removeChild(s); delete window[cb]; };

      window[cb] = (data) => { if (done) return; done = true; cleanup(); resolve({ method:"jsonp", data }); };
      s.onerror = async () => {
        if (done) return; done = true; cleanup();
        try {
          const res = await fetch(base + "&format=json", { mode:"cors" });
          const data = await res.json();
          resolve({ method:"fetch", data });
        } catch (e){
          resolve({ method:"error", data:{ error:"Network error loading script and fetch" } });
        }
      };
      s.src = base + "&callback=" + cb;
      document.body.appendChild(s);

      // timeout fallback
      setTimeout(async () => {
        if (done) return;
        done = true; cleanup();
        try {
          const res = await fetch(base + "&format=json", { mode:"cors" });
          const data = await res.json();
          resolve({ method:"fetch-timeout", data });
        } catch (e){
          resolve({ method:"timeout", data:{ error:"Timeout then fetch failed" } });
        }
      }, timeoutMs);
    });
  }

  // ====== existing refs (unchanged UI) ======
  const qs = new URLSearchParams(window.location.search);
  const part = (qs.get("part") || "UNKNOWN").toUpperCase();
  const loc  = (qs.get("loc")  || "A").toUpperCase();
  const desc = qs.get("desc") || "";

  const liveEl = document.getElementById("live");
  document.getElementById("part-id").textContent = part;
  document.getElementById("loc").textContent = loc;
  document.getElementById("desc").textContent = desc;

  const initialsEl = document.getElementById("initials");
  const statusUser = document.getElementById("status-user");
  const takenEl = document.getElementById("taken");
  const addedEl = document.getElementById("added");
  const statusUpdate = document.getElementById("status-update");
  const vanSel = document.getElementById("van");
  const qtyEl  = document.getElementById("qty");
  const statusTransfer = document.getElementById("status-transfer");
  const logTBody = document.querySelector("#log-table tbody");
  const statusLog = document.getElementById("status-log");

  initialsEl.value = localStorage.getItem("ss_initials") || "";
  initialsEl.addEventListener("input", () => {
    localStorage.setItem("ss_initials", initialsEl.value.trim().toUpperCase());
    statusUser.textContent = initialsEl.value ? "Initials saved." : "";
  });
  function userParam(){ return "&user=" + encodeURIComponent((initialsEl.value || "").trim().toUpperCase()); }

  async function loadLive(){
    const {method, data} = await api(`op=read&part=${encodeURIComponent(part)}&loc=${encodeURIComponent(loc)}${userParam()}`);
    if (data && data.ok){ liveEl.textContent = data.live; setConn(true, method); }
    else { liveEl.textContent = "–"; setConn(false, (data && data.error) || "read failed"); }
  }

  async function loadVans(){
    vanSel.innerHTML = `<option value="">— select van —</option>`;
    const seeded = ['N141 FOX','WP70 ROU','BJ74 EZW','YS71 HYX','YM22 XBG','YR23 MYS','YP74 XCU','YM23 LRE'];
    try{
      const {data} = await api(`op=listvans${userParam()}`);
      const vans = (data && data.ok && Array.isArray(data.vans) ? data.vans : seeded);
      (vans.length ? vans : seeded).forEach(v => {
        const opt = document.createElement("option");
        opt.value = v; opt.textContent = v; vanSel.appendChild(opt);
      });
    }catch(e){
      seeded.forEach(v => { const o=document.createElement("option"); o.value=v; o.textContent=v; vanSel.appendChild(o); });
    }
  }

  async function loadLog(){
    logTBody.innerHTML = "";
    const {data} = await api(`op=log&limit=5${userParam()}`);
    if (data && data.ok){
      setConn(true, "ok");
      (data.logs || []).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${new Date(r.date).toLocaleString()}</td>
                        <td>${r.part||""}</td>
                        <td>${r.desc||""}</td>
                        <td>${r.location||""}</td>
                        <td>${r.change||""}</td>
                        <td>${r.newCount||""}</td>
                        <td>${r.user||""}</td>
                        <td>${r.van||""}</td>
                        <td>${r.vanQty||""}</td>`;
        logTBody.appendChild(tr);
      });
      if (!data.logs || !data.logs.length){
        statusLog.className = "notice muted";
        statusLog.textContent = "No recent changes.";
      } else {
        statusLog.textContent = "";
      }
    } else {
      setConn(false, (data && data.error) || "log failed");
      statusLog.className = "notice err";
      statusLog.textContent = (data && data.error) || "Could not load history";
    }
  }

  document.getElementById("btn-update").addEventListener("click", async () => {
    const taken = parseInt(takenEl.value || "0", 10);
    const added = parseInt(addedEl.value || "0", 10);
    if ((isNaN(taken) || isNaN(added)) || (taken === 0 && added === 0)) {
      statusUpdate.className="notice err"; statusUpdate.textContent = "Enter a value in either TAKEN or ADDED."; return;
    }
    const delta = (added || 0) - (taken || 0);
    const {data} = await api(`op=update&part=${encodeURIComponent(part)}&loc=${encodeURIComponent(loc)}&delta=${encodeURIComponent(delta)}${userParam()}`);
    if (data && data.ok){
      statusUpdate.className="notice ok"; statusUpdate.textContent = `Updated ✔ (was ${data.live_before}, now ${data.live})`;
      takenEl.value = ""; addedEl.value = "";
      loadLive(); loadLog();
    } else {
      statusUpdate.className="notice err"; statusUpdate.textContent = (data && data.error) || "Update failed";
    }
  });

  document.getElementById("btn-transfer").addEventListener("click", async () => {
    const van = (vanSel.value || "").trim();
    if (!van) { statusTransfer.className="notice err"; statusTransfer.textContent = "Please select a van."; return; }
    const qty = parseInt(qtyEl.value || "0", 10);
    if (!(qty > 0)) { statusTransfer.className="notice err"; statusTransfer.textContent = "Enter a quantity > 0."; return; }
    const dir = (document.querySelector('input[name="dir"]:checked') || {}).value || "to-van";
    let from = loc, to = van;
    if (dir === "to-workshop"){ from = van; to = loc; }
    const {data} = await api(`op=transfer&part=${encodeURIComponent(part)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&qty=${encodeURIComponent(qty)}${userParam()}`);
    if (data && data.ok){
      statusTransfer.className="notice ok"; statusTransfer.textContent = `Transferred ✔ ${qty} (${data.from} → ${data.to})`;
      qtyEl.value = "";
      loadLive(); loadLog();
    } else {
      statusTransfer.className="notice err"; statusTransfer.textContent = (data && data.error) || "Transfer failed";
    }
  });

  document.getElementById("btn-install").addEventListener("click", async () => {
    const van = (vanSel.value || "").trim();
    if (!van) { statusTransfer.className="notice err"; statusTransfer.textContent = "Please select a van."; return; }
    const qty = parseInt(qtyEl.value || "0", 10);
    if (!(qty > 0)) { statusTransfer.className="notice err"; statusTransfer.textContent = "Enter a quantity > 0."; return; }
    const {data} = await api(`op=install&part=${encodeURIComponent(part)}&van=${encodeURIComponent(van)}&qty=${encodeURIComponent(qty)}${userParam()}`);
    if (data && data.ok){
      statusTransfer.className="notice ok"; statusTransfer.textContent = `Installed ✔ ${qty} from ${van} (was ${data.live_before}, now ${data.live})`;
      qtyEl.value = "";
      loadLive(); loadLog();
    } else {
      statusTransfer.className="notice err"; statusTransfer.textContent = (data && data.error) || "Install failed";
    }
  });

  // init
  loadLive();
  loadVans();
  loadLog();
</script>
